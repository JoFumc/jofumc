<?php
/****************************************************************************
 * class-form.php -- Define object classes for forms
 ***************************************************************************/

/*
 * CONSTANTS
 */
  /* Encodings */
define("FORM_FORMAT_URL","application/x-www-form-urlencoded");
define("FORM_FORMAT_BINARY","multipart/form-data");
  /* Processor methods */
define("FORM_METHOD_GET","get");
define("FORM_METHOD_POST","post");
  /* Input types */
define("FORM_ITEM_HIDDEN","hidden");
define("FORM_ITEM_BUTTON","button");
define("FORM_ITEM_SUBMIT","submit");
define("FORM_ITEM_FILE","file");
define("FORM_ITEM_CHECK","checkbox");
define("FORM_ITEM_TEXT","text");
define("FORM_ITEM_TEXTAREA","textarea");
define("FORM_ITEM_PASSWORD","password");
define("FORM_ITEM_SELECT","select");
define("FORM_ITEM_RADIO","radio");
define("FORM_ITEM_RAW","raw");

/*
 * akFormItem -- Individual form element, union of all item types
 */

class akFormItem
{
  /* Basic public members */
  public $id;    // Item identifier (DOM)
  public $name;  // Item name (form field name)
  public $type;  // Item type (hidden, text, button, etc.) 
  public $value; // Currently-assigned value for this form item
  public $label; // If non-empty, label for item (makes a new DOM element)
  public $hsize;  // Size attribute (columns)
  public $max_hsize; // Max-size attribute (columns)
  public $vsize;     // Size attribute (rows)
  public $prefix; // HTML for cell preceeding item's cells
  public $suffix; // HTML for cell following item's cells

  /* Non-standard bits */
  public $hint;  // Form element hint (placeholder, perhaps)
  private $style; // Local item style (USE WITH CAUTION)
  private $events; // Events and handlers

  /* Constructor */
  function __construct($id=null, $type=null, $name=null, $value=null, $label=null)
  {
    /* Step 1: Load basic member info */
      /* CLEAN: Throw exception on bad inits? */
    $this->id = $id;
    $this->type = $type;
    $this->name = $name;
    $this->value = $value;
    $this->label = $label;

    /* Step 2: Interpretive defaults, should be overwritten */
    $this->prefix=null;
    $this->suffix=null;
    $this->hsize=null;
    $this->vsize=null; 
    $this->max_hsize=256; // CLEAN: Make this a constant? 
    $this->hint = null; 
    $this->style = null;
    $this->events = array();
  }

  function addStyle($parm=null,$value=null)
  {
    if ((null != $parm) && (null != $value))
      $this->style .= $parm.':'.$value.';';
  }

  function addEvent($event=null,$handler=null)
  {
    if (($event != null) && ($handler != null)) {
      $this->events[$event] = $handler;
    }
  }

  /* Method to emit the HTML for this item */
    /* NOTE: Each item takes up a 4-cell row in the
     *       form table: prefix,label,content,suffix.
     */
  function emit()
  {
    /* Row container */
    print '<tr ';
    print '    class="form-item-row form-item-'.$this->type.'-row" ';
    print '    id="'.$this->id.'-row" ';
    print '>'."\n";
    /* Prefix cell */
    print '<td ';
    print '   class="form-item-prefix" ';
    print '    id="'.$this->id.'-prefix" ';
    print '>';
    if (null != $this->prefix) print $this->prefix;
    print '</td>';
    /* Label cell (if not raw HTML content) */
    if ($this->type != FORM_ITEM_RAW) {
      print '<td ';
      print '   class="form-item form-item-label" ';
      print '   id="'.$this->id.'-label" ';
      print '>';
      /* Radio buttons have label on the inside... */
      if ((null != $this->label) && ($this->type != FORM_ITEM_RADIO)) {
        print '<label class="form-item-label" for="'.$this->id.'">'.$this->label."</label>\n";
      }
      print '</td>';
      /* Contents cell */
      print '<td ';
      print '   class="form-item-contents" ';
      print '   id="'.$this->id.'-contents" ';
      print '>';
    } else {
      // For RAW, both cells are the raw content
      print '<td class="form-item-raw" colspan="2">';
    }
    /* Switch on type */
    switch($this->type) {
      case FORM_ITEM_RAW: {
        // Extra bits inside the form...
        print '<div ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-raw" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print '>';
        print $this->value;
        print '</div>';
        break;
      }
      case FORM_ITEM_HIDDEN: {
        // Hidden field for passing data 
        print '<input ';
        print '  type="hidden" ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-hidden" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        break;
      }   
      case FORM_ITEM_TEXT: {
        // Simple text entry
        print '<input ';
        print '  type="text" ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-text" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->hsize)
          print 'size="'.$this->hsize.'" ';
        print '  maxlength="'.$this->max_hsize.'" ';
        if (null != $this->hint) 
          print 'placeholder="'.$this->hint.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        break;
      }
      case FORM_ITEM_TEXTAREA: {
        // Multiline text entry 
        print '<textarea ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-textarea" ';
        print '  name="'.$this->name.'" ';
        if (null != $this->hsize)
          print 'cols="'.$this->hsize.'" ';
        if (null != $this->vsize)
          print 'rows="'.$this->vsize.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        print $this->value;
        print '</textarea>';
        break;
      }
      case FORM_ITEM_RADIO: {
        // Radio button
        print '<input ';
        print '  type="radio" ';
        //print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-radio" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->hint) 
          print '  checked="'.$this->hint.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>".$this->label."\n";
        break;
      }
      case FORM_ITEM_PASSWORD: {
        // Password field
        print '<input ';
        print '  type="password" ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-password" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->hsize)
          print 'size="'.$this->hsize.'" ';
        print '  maxlength="'.$this->max_hsize.'" ';
        if (null != $this->hint) 
          print '  placeholder="'.$this->hint.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        break;
      }
      case FORM_ITEM_BUTTON: {
        // Generic button (remember to add an onClick event)
        print '<input ';
        print '  type="button" ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-button" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        break;
      }
      case FORM_ITEM_SUBMIT: {
        // Submit button 
        print '<input ';
        print '  type="submit" ';
        print '  id="'.$this->id.'" ';
        print '  class="form-item form-item-submit" ';
        print '  name="'.$this->name.'" ';
        print '  value="'.$this->value.'" ';
        if (null != $this->style)
          print 'style="'.$this->style.'" ';
        foreach(array_keys($this->events) as $evkey)
          print $evkey.'="'.$this->events[$evkey].'" ';
        print "/>\n";
        break;
      }
    }
    print '</td>';
    // Suffix cell
    print '<td ';
    print '    class="form-item-suffix" ';
    print '    id="'.$this->id.'-suffix" ';
    print '>';
    if (null != $this->suffix) print $this->suffix;
    print '</td>';

    print '</tr>'."\n";
  }
}

/*
 * akForm -- Structural form object
 */
class akForm
{
  /* Basic public members */
  public $id;   // Form identifier (DOM)
  public $method; // Method for processing
  public $action; // URL or service that will process this form
 
  /* Advanced public members */
  public $format; // How to format data 
  public $accept; // For uploads, which types to accept
  public $charset; // What charset the server expects
  public $lastSimpleItem; // Reference to last simple item created

  /* Private members */
  private $items; // Array of items 

  /* Wrapper public members (customization) */
    /* NOTE: These will be in the form DIV, but
     *       outside the FORM element.
     */
  public $header_text;
  public $header_file;
  public $footer_text;
  public $footer_file;

  /* Event handlers */
      /* CLEAN: Add this */

  /* Constructor */
  function __construct($id=null, $action=null, $method=FORM_METHOD_POST)
  {
    /* Step 1: Load basic member info */
      /* CLEAN: Throw exception on bad inits? */
    $this->id = $id;
    $this->action = $action;
    $this->method = $method;

    /* Step 2: Defaults */
      /* Caller must set these... */
    $this->format=null;
    $this->accept=null;
    $this->charset=null;
    $this->header_text=null;
    $this->header_file=null;
    $this->footer_text=null;
    $this->footer_file=null;
  }

  /* Method to adopt a form item */
  function adopt($item=null)
  {
    if ($item == null) return; // CLEAN: throw a warning here?
    /* Add to array */
    $this->items[] = &$item;
  }

  /* Method to create and adopt a simple item */
  function createSimpleItem($id=null,$type=null,$name=null,$value=null,$label=null)
  {
    $item = new akFormItem($id,$type,$name,$value,$label);
    $this->adopt($item);
    $this->lastSimpleItem = &$item;
  }

  /* Method to emit the HTML for this form */
  function emit()
  {
    print '<div class="form-div">'."\n";
    if (null != $this->header_text) print $this->header_text;
    if (null != $this->header_file) @include($this->header_file);
    print '<form ';
    print '  id="'.$this->id.'" ';
    print '  method="'.$this->method.'" ';
    print '  action="'.$this->action.'" ';
    if (null != $this->format)
      print '  enctype="'.$this->format.'" ';
    if (null != $this->accept)
      print '  accept="'.$this->accept.'" ';
    if (null != $this->charset)
      print '  accept-charset="'.$this->charset.'" ';
    print ">\n";
    /* Loop over all items as a table */
    print '<table class="form-table">';
    foreach ($this->items as $item) $item->emit();
    print "</table>\n";
    print "</form>\n";
    if (null != $this->footer_file) @include($this->footer_file);
    if (null != $this->footer_text) print $this->footer_text;
    print "</div>\n";
  }
}


?>
